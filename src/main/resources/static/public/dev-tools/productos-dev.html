<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dev Tools — Visor de Productos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent:#ff6f00; /* naranja del html de contexto */
      --accent-dark:#e65f00;
      --muted:#f5f5f5;
      --panel:#ffffff;
      --text:#0f172a;
      --green:#064e3b;
      --border:#e6e6e6;
    }
    html,body{height:100%;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:var(--muted);color:var(--text)}
    .container{max-width:1200px;margin:20px auto;padding:18px;background:var(--panel);box-shadow:0 2px 6px rgba(0,0,0,0.06);border-radius:6px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header h1{font-size:18px;margin:0;color:var(--green)}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--border)}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{background:linear-gradient(0deg, rgba(0,0,0,0.02), transparent);text-align:left;padding:10px;border-bottom:1px solid var(--border);font-size:13px}
    tbody tr{border-bottom:1px solid var(--border)}
    tbody td{padding:10px;vertical-align:middle;font-size:14px}
    .thumb{width:80px;height:80px;border:1px solid #ddd;background:#fafafa;display:inline-block;overflow:hidden;border-radius:4px}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .muted{color:#6b7280;font-size:13px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border);font-size:13px}
    .right{text-align:right}
    @media(max-width:900px){
      .container{padding:12px}
      thead th:nth-child(1),tbody td:nth-child(1){display:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Visor de Productos (Dev)</h1>
      <div class="controls">
        <button class="btn" id="btn-refresh">Refrescar</button>
        <button class="btn secondary" id="btn-toggle-sample">Alternar ejemplo</button>
      </div>
    </header>

    <section>
      <table id="productos-table" aria-describedby="tabla-productos">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Usuario</th>
            <th>Precio</th>
            <th>Creado</th>
            <th>Stock</th>
            <th>Reservas</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- filas se renderizan desde JS -->
        </tbody>
      </table>
    </section>

    <footer style="margin-top:12px;color:#6b7280;font-size:13px">
      Esta vista es para desarrollo: posteriormente las filas se cargarán desde la API.
    </footer>
  </div>

  <script>
    // Datos de ejemplo para desarrollo. Puedes alternar con el botón "Alternar ejemplo".
    const SAMPLE = [
      {id:1,nombre:'Auriculares XY-100',usuario:'pepito@ejemplo.com',precioCentavos:129990,creado:'2025-12-10T14:32:00Z',stock:45,reservas:2,imagen:'/static/images/placeholder-80x80.png'},
      {id:2,nombre:'Cargador Turbo 30W',usuario:'maria@ejemplo.com',precioCentavos:3990,creado:'2025-11-02T09:10:00Z',stock:0,reservas:5,imagen:'/static/images/placeholder-80x80.png'}
    ];

    // Por defecto intentamos cargar desde la API (si tu app corre en la misma origin).
    let useSample = false;

    function formatMoney(cents){ if (cents==null) return '-'; return '$ ' + (Math.round(cents/100).toLocaleString('es-AR')); }
    function formatDate(iso){ try{ const d=new Date(iso); return d.toLocaleString('es-AR'); }catch(e){ return iso; } }

    function renderTable(items){
      const tbody = document.querySelector('#productos-table tbody');
      tbody.innerHTML = '';
      if(!items || items.length===0){
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan=8; td.className='muted'; td.textContent='No hay productos para mostrar.'; tr.appendChild(td); tbody.appendChild(tr); return;
      }
      items.forEach(it=>{
        const tr = document.createElement('tr');

        const tdImg = document.createElement('td');
        const div = document.createElement('span'); div.className='thumb';
        const img = document.createElement('img'); img.alt = it.nombre || 'Imagen'; img.src = it.imagen || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="100%" height="100%" fill="%23f0f0f0"/><text x="50%" y="50%" font-size="12" text-anchor="middle" dominant-baseline="middle" fill="%23999">no image</text></svg>';
        div.appendChild(img); tdImg.appendChild(div); tr.appendChild(tdImg);

        const tdNombre = document.createElement('td'); tdNombre.textContent = it.nombre || ''; tr.appendChild(tdNombre);
        const tdUser = document.createElement('td'); tdUser.textContent = it.usuario || ''; tr.appendChild(tdUser);
        const tdPrecio = document.createElement('td'); tdPrecio.textContent = formatMoney(it.precioCentavos); tr.appendChild(tdPrecio);
        const tdCre = document.createElement('td'); tdCre.textContent = formatDate(it.creado); tr.appendChild(tdCre);
        const tdStock = document.createElement('td'); tdStock.textContent = (it.stock!=null?it.stock:'-'); tr.appendChild(tdStock);
        const tdRes = document.createElement('td'); tdRes.textContent = (it.reservas!=null?it.reservas:'-'); tr.appendChild(tdRes);

        const tdAct = document.createElement('td'); tdAct.className='right';
        const btn = document.createElement('button'); btn.className='btn secondary'; btn.textContent='Ver'; btn.onclick = ()=>{ window.location.href = '/public/producto/mostrar/producto-simple.html?id=' + encodeURIComponent(it.id); };
        tdAct.appendChild(btn); tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });
    }

    // Hooks para llamadas a la API: carga /api/productos/detalle que devuelve lista de objetos detalle
    function normalizeUrl(u){
      if(!u) return '';
      try{ u = String(u).trim(); }catch(e){ return ''; }
      if(/^https?:\/\//i.test(u)) return u;
      if(u.startsWith('/')) return window.location.origin + u;
      return window.location.origin + '/' + u;
    }

    async function loadFromApi(){
      if(useSample){ renderTable(SAMPLE); return; }

      const API = '/api/productos/detalle'; // usa mismo origen
      try{
          const resp = await fetch(API, { headers: { 'Accept': 'application/json' } });
          if(!resp.ok){ console.error('API error', resp.status); renderTable([]); return; }
          const body = await resp.json();

          // body expected: Array of { producto, imagenes, precio, stock, opciones, physical }
          const detalles = Array.isArray(body) ? body : (body?.data || []);

          // Traer inventario y construir mapa por productoId
          let inventarioMap = new Map();
          try{
            const invResp = await fetch('/api/inventario', { headers: { 'Accept': 'application/json' } });
            if(invResp.ok){
              const invBody = await invResp.json();
              if(Array.isArray(invBody)){
                invBody.forEach(i => { if(i && i.productoId!=null) inventarioMap.set(String(i.productoId), i); });
              }
            } else {
              console.warn('Inventario API returned', invResp.status);
            }
          }catch(e){ console.warn('Error fetching inventario', e); }

          const mapped = detalles.map(d => {
            const prod = d.producto || d || {};
            const imgObj = Array.isArray(d.imagenes) && d.imagenes.length>0 ? d.imagenes[0] : null;
            const rawImg = imgObj?.url || imgObj?.path || prod?.imagen || prod?.imagenPrincipal || prod?.image || '';
            const imagen = normalizeUrl(rawImg);

            const usuario = prod?.creadoPor || prod?.creadoPorEmail || prod?.usuario || prod?.propietario || prod?.createdBy || '-';
            const precioCentavos = d.precio?.montoCentavos ?? prod?.precioCentavos ?? null;
            const creado = prod?.createdAt || prod?.creado || prod?.created || prod?.created_at || null;

            // preferir inventario global si existe
            const inv = inventarioMap.get(String(prod?.id));
            const stock = inv?.disponible ?? d.stock?.disponible ?? (d.stock ?? null);
            const reservas = (inv && inv.reserved != null) ? inv.reserved : null;

            return {
              id: prod?.id ?? null,
              nombre: prod?.nombre ?? prod?.title ?? '',
              usuario,
              precioCentavos,
              creado,
              stock,
              reservas,
              imagen
            };
          });

          renderTable(mapped);
      }catch(e){ console.error('Error loadFromApi', e); renderTable([]); }
    }

    document.getElementById('btn-refresh').addEventListener('click', ()=> loadFromApi());
    document.getElementById('btn-toggle-sample').addEventListener('click', ()=>{ useSample=!useSample; loadFromApi(); });

    // iniciar
    loadFromApi();
  </script>
</body>
</html>
